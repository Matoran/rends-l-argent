<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rends l'argent</title>
    <style>
        canvas {
            height: 700px;
            width: 700px;
            float: left;
        }

        form{
            float: left;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="700" height="700"></canvas>
<form method="post" id="form">
    <p>
    <div id="blocType" style="display: none">
        <label for="typeCarte">Quel type de carte?</label><br />
        <select name="typeCarte" id="typeCarte">
            <option value="Propriete">Propriété</option>
            <option value="Gare">Gare</option>
            <option value="Chance">Chance</option>
            <option value="Caisse de communaute">Caisse de communauté</option>
            <option value="Services publiques">Services publiques</option>
            <option value="Impots et taxe">Impôts et taxe</option>
            <option value="Prison">Prison</option>
            <option value="Aller en prison">Aller en prison</option>
            <option value="Parking gratuit">Parking gratuit</option>
        </select>
    </div>
    <div id="blocService" style="display: none">
        <label for="service">Quel type de Service publique?</label><br />
        <select name="service" id="service">
            <option value="Electricite">Electricité</option>
            <option value="Eau">Eau</option>
        </select>
    </div>
    <div id="blocTaxe" style="display: none">
        <label for="taxe">Quel type d'impôts et taxe?</label><br />
        <select name="taxe" id="taxe">
            <option value="luxe">Objet de luxe</option>
            <option value="impots">Impôts</option>
        </select>
    </div>
    <div id="blocName" style="display: none">
        <label for="name">Nom de la carte</label><br />
        <input id="name" name="name" value="Nom">
    </div>
    <div id="blocColor" style="display: none">
        <label for="color">Couleur de la famille de carte</label><br />
        <select name="color" id="color">
            <option value="red">Rouge</option>
            <option value="blue">Bleu</option>
            <option value="orange">Orange</option>
            <option value="black">Noir</option>
            <option value="green">Vert</option>
            <option value="purple">Violet</option>
            <option value="pink">Rose</option>
            <option value="yellow">Jaune</option>
        </select>
    </div>
    <div id="blocPrice" style="display: none">
        <label for="name">Prix</label><br />
        <input type="number" id="price" name="price" value="1"/>
    </div>
    <input type="button" value="valider" id="button" onclick="send()" style="display: none">
    </p>
    <input type="hidden" id="id" value="">
</form>
</body>
<script src="easeljs-0.8.2.min.js"></script>
<script src="Bank.js"></script>
<script src="Cell.js"></script>
<script src="Square.js"></script>
<script src="Tax.js"></script>
<script src="CommunityChest.js"></script>
<script src="Chance.js"></script>
<script src="Buyable.js"></script>
<script src="Station.js"></script>
<script src="Property.js"></script>
<script src="Player.js"></script>
<script src="Board.js"></script>
<script>
    //----------------draw board-----------------------
    let board = Board();
    let stage = new createjs.Stage("canvas");

    function squareOnClick(identifiant) {
        let type = document.getElementById("blocType");
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let button = document.getElementById("button");
        let id = document.getElementById("id");
        id.value = identifiant;
        type.style.display = "block";
        name.style.display = "block";
        price.style.display = "block";
        color.style.display = "block";
        button.style.display = "block";
        let card = document.getElementById('typeCarte');
        card.selectedIndex = "Propriete";
    }

    function strcutSquare(posx,posy, w, h, color, id, dx, dy, cell){
        return{
            posx : posx,
            posy : posy,
            width : w,
            heigth : h,
            color : color,
            id : id,
            directionX : dx,
            directionY : dy,
            cell : cell
        };
    }

    function square(squareParam) {
        let square = new createjs.Shape();
        let commandSquare = square.graphics.beginFill("black").command;
        square.graphics.drawRect(0, 0, squareParam.width, squareParam.heigth);
        square.x = squareParam.posx;
        square.y = squareParam.posy;
        commandSquare.style = squareParam.color;
        if(squareParam.id !== 0 && squareParam.id !== 10 && squareParam.id !== 20 && squareParam.id !== 30) {
            square.on("click", function () {
                squareOnClick(squareParam.id);
            });
        }
        let label = new createjs.Text("", "12px Arial", "#000000");
        stage.addChild(square);
        return{
            square : square,
            commandeSquare: commandSquare,
            label : label,
            struct : squareParam,
            in : undefined,
            circle : undefined,
            img : undefined
        };
    }
    
    function circle(posx, posy, r, color) {
        let circle = new createjs.Shape();
        let commandeCircle = circle.graphics.beginFill(color).command;
        circle.graphics.drawCircle(0, 0, r);
        circle.x = posx;
        circle.y = posy;
        stage.addChild(circle);
        return {
            circle : circle,
            commandCircle : commandeCircle
        };
    }

    function image(src, posx, posy){
        let img = new Image();
        img.src = src;
        img.onload = function (event) {
            let image = event.target;
            let bitmap = new createjs.Bitmap(image);
            bitmap.x = posx;
            bitmap.y = posy;
            stage.addChild(bitmap);
            stage.update();
        };
        return img;
    }

    function text(txt, posx, posy, id){
        tabSquare[id].label.text = txt;
        tabSquare[id].label.x = posx;
        tabSquare[id].label.y = posy;
        tabSquare[id].label.alpha = 0.5;
        stage.addChild( tabSquare[id].label);
        stage.update();
    }

    //draw background
    let background = new createjs.Shape();
    background.graphics.beginFill("#79BD9A").drawRect(0, 0, 700, 700);
    stage.addChild(background);


    //draw board
    let tabSquare = [];
    let color;
    const squareSize = 90;
    const rectangleWidth = 58;
    let y = 0;
    let x = 0;
    let directionX = 1;
    let directionY = 0;
    for(let i = 0; i < 40; i++){
        let cell = board.squares()[i];
        if(i % 2 === 0){
            color = "#3B8686";
        }else{
            color = "#0B486B";
        }

        if(i % 10 === 0){
            if(directionX === -1){
                x -= squareSize-rectangleWidth;
            }
            tabSquare.push(square(strcutSquare(x, y, squareSize, squareSize,color,i,directionX,directionY,cell)));
            color = "black";
            text(cell.name(),x,y+20,i);
            if(directionX === 1 && i !== 0){
                directionX = 0;
                directionY = 1;
                y+= squareSize;
            }else if(directionY === 1){
                directionX = -1;
                directionY = 0;
                x -= rectangleWidth;
            }else if(directionX === -1){
                directionX = 0;
                directionY = -1;
                y-= rectangleWidth;
            }else if(directionX === 1){
                x+= squareSize;
            }
        }else{
            if(directionX === 1 || directionX === -1){
                tabSquare.push(square(strcutSquare(x, y, rectangleWidth, squareSize, color, i,directionX,directionY,cell)));
                if (cell.isBuyable()) {
                    if (directionX === 1) {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + rectangleWidth/2, y + squareSize + 10, 5, color);
                    } else {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + rectangleWidth/2, y -10, 5, color);
                    }
                }
                if(cell.isProperty()) {
                    if (directionX === 1) {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + squareSize - 20, rectangleWidth - 20, 10,color,i,directionX,directionY,cell));
                    } else {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + 10, rectangleWidth - 20, 10,color,i,directionX,directionY,cell));
                    }
                }else if(cell.isTrain()){
                    tabSquare[i].img = image("img/train.png", x, y);
                }else if(cell.isChance()){
                    tabSquare[i].img = image("img/chance.png", x, y);
                }else if(cell.isCommunityChest()){
                    tabSquare[i].img = image("img/chest.png", x, y);
                }else if(cell.isTax()){
                    tabSquare[i].img = image("img/tax.png", x, y);
                }

                x += rectangleWidth*directionX;
                y += squareSize*directionY;

            }else if(directionY === 1 || directionY === -1){
                tabSquare.push(square(strcutSquare(x, y, squareSize, rectangleWidth,color,i,directionX,directionY,cell)));
                if (cell.isBuyable()) {
                    if (directionY === 1) {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x - 10, y + rectangleWidth / 2, 5, color);
                    } else {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + squareSize + 10, y + rectangleWidth / 2, 5, color);
                    }
                }
                if(cell.isProperty()) {
                    if (directionY === 1) {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + 10, 10, rectangleWidth - 20,color,i,directionX,directionY,cell));
                    } else {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + squareSize - 20, y + 10, 10, rectangleWidth - 20,color,i,directionX,directionY,cell));
                    }
                }else if(cell.isTrain()){
                    tabSquare[i].img = image("img/train.png", x, y);
                }else if(cell.isChance()){
                    tabSquare[i].img = image("img/chance.png", x, y);
                }else if(cell.isCommunityChest()){
                    tabSquare[i].img = image("img/chest.png", x, y);
                }else if(cell.isTax()){
                    tabSquare[i].img = image("img/tax.png", x, y);
                }
                x += squareSize*directionX;
                y += rectangleWidth*directionY;
            }
        }
    }

    tabSquare.forEach(function (s) {
        stage.addChild(s.label);
    });
    stage.update();

    //----------Form--------------------
    var card = document.getElementById('typeCarte');
    // change the form
    card.addEventListener('change', function() {
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let service = document.getElementById("blocService");
        let taxe = document.getElementById("blocTaxe");

        let value = card.options[card.selectedIndex].value;

        name.style.display = "none";
        price.style.display = "none";
        color.style.display = "none";
        service.style.display = "none";
        taxe.style.display = "none";

        if(value == "Propriete"){
            name.style.display = "block";
            price.style.display = "block";
            color.style.display = "block";
        }else if(value == "Gare"){
            name.style.display = "block";
        }else if(value == "Services publiques"){
            service.style.display = "block";
        }else if(value == "Impots et taxe") {
            taxe.style.display = "block";
        }
    });

    function cleanForm(){
        let type = document.getElementById("blocType");
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let button = document.getElementById("button");
        let id = document.getElementById("id");
        let service = document.getElementById("blocService");
        let taxe = document.getElementById("blocTaxe");
        id.value = 0;
        type.style.display = "none";
        name.style.display = "none";
        price.style.display = "none";
        color.style.display = "none";
        button.style.display = "none";
        service.style.display = "none";
        taxe.style.display = "none";
    }

    function send() {
        let id = document.getElementById("id").value;
        let value = card.options[card.selectedIndex].value;
        let name = document.getElementById("name").value;
        let color = document.getElementById("color").value;
        let price = document.getElementById("price").value;
        let service = document.getElementById("service");
        service = service.options[service.selectedIndex].value;
        let taxe = document.getElementById("taxe");
        taxe = taxe.options[taxe.selectedIndex].value;

        if(tabSquare[id].in !== undefined){
            stage.removeChild(tabSquare[id].in.square);
        }

        if(tabSquare[id].circle !== undefined){
            stage.removeChild(tabSquare[id].circle.circle);
            tabSquare[id].circle = undefined;
        }

        if(tabSquare[id].img !== undefined){
            stage.removeChild(tabSquare[id].img.src = "");
        }


        let x = tabSquare[id].struct.posx;
        let y = tabSquare[id].struct.posy;
        let dx = tabSquare[id].struct.directionX;
        let dy = tabSquare[id].struct.directionY;
        let cell = tabSquare[id].struct.cell;
        if(dx === 1 || dx === -1){
            if(value == "Propriete" || value == "Gare") {
                if (dx === 1) {
                    tabSquare[id].circle = circle(x + rectangleWidth/2, y + squareSize + 10, 5, "yellow");
                } else {
                    tabSquare[id].circle = circle(x + rectangleWidth/2, y -10, 5, "yellow");
                }
            }
            if(value === "Propriete") {
                if (dx === 1) {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + squareSize - 20, rectangleWidth - 20, 10,color,id,dx,dy,cell));
                } else {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + 10, rectangleWidth - 20, 10,color,id,dx,dy,cell));
                }
            }
        }else if(dy === 1 || dy === -1){
            if(value == "Propriete" || value == "Gare") {
                if (dy === 1) {
                    tabSquare[id].circle = circle(x - 10, y + rectangleWidth / 2, 5, "yellow");
                } else {
                    tabSquare[id].circle = circle(x + squareSize + 10, y + rectangleWidth / 2, 5, "yellow");
                }
            }
            if(value === "Propriete") {
                if (dy === 1) {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + 10, 10, rectangleWidth - 20,color,id,dx,dy,cell));
                } else {
                    tabSquare[id].in = square(strcutSquare(x + squareSize - 20, y + 10, 10, rectangleWidth - 20,color,id,dx,dy,cell));
                }
            }
        }

        if(value === "Gare"){
            tabSquare[id].img = image("img/train.png", x, y);
        }else if(value === "Impots et taxe"){
            tabSquare[id].img = image("img/tax.png", x, y);
        }else if(value === "Caisse de communaute"){
            tabSquare[id].img = image("img/chest.png", x, y);
        }else if(value === "Chance"){
            tabSquare[id].img = image("img/chance.png", x, y);
        }/*else if(value === "Services publiques"){

        }*/


        stage.update();
        cleanForm();
    }

    //----------Move Player--------
    let tabTokens = [];
    board.players().forEach(function (p) {
        tabTokens.push(circle(tabSquare[p.position()].square.x + 30, tabSquare[p.position()].square.y +20, 5,p.color()));
    });
    function movePlayers() {
        for(let i = 0; i < tabTokens.length; i++){
           tabTokens[i].circle.x =  tabSquare[board.players()[i].position()].square.x + 30 + (i*6);
           tabTokens[i].circle.y =  tabSquare[board.players()[i].position()].square.y + 20 + (i*6);
        }
        stage.update();
    }

    //-------------Play--------------
    movePlayers();
    let squares = [];
    let labels = [];
    play();
    function play() {
        squares.forEach(function (s) {
            stage.removeChild(s);
        });
        labels.forEach(function (l) {
            stage.removeChild(l);
        })
        squares = [];
        let tabAction = board.actions();
        for(let i = 0; i < tabAction.length; i++){
            let square = new createjs.Shape();
            square.graphics.beginFill("#0B486B").drawRect(0, 0, 50, 50);
            square.x = 110 + (i*55);
            square.y = 540;
            square.on("click", function(){
                tabAction[i]();
                if(tabAction[i].name === "buy"){
                    tabSquare[board.players()[board.activePlayer()].position()].circle.commandCircle.style = board.players()[board.activePlayer()].color();
                }
                movePlayers();
                play();
            });
            let label = new createjs.Text("", "12px Arial", "#000000");
            label.text = tabAction[i].name;
            label.x = square.x;
            label.y = square.y;
            squares.push(square);
            labels.push(label);
            stage.addChild(square);
            stage.addChild(label);
            stage.update();
        }
    }


    /*//--------------Dice-----------------
let img = new Image();
img.src = "img/dice-1-th.png";
let img2 = new Image();
img2.src = "img/dice-1-th.png";

function drawImage(posx,posy, event) {
    let image = event.target;
    let bitmap = new createjs.Bitmap(image);
    bitmap.x = posx;
    bitmap.y = posy;
    bitmap.addEventListener("click", onClick);
    stage.addChild(bitmap);
    stage.update();
}

img.onload = function (event) {drawImage(0,0, event);};
img2.onload = function (event) {drawImage(100,0, event);};

function onClick() {
    let rand = Math.floor((Math.random() * 6) + 1);
    let rand2 = Math.floor((Math.random() * 6) + 1);
    img.src = "img/dice-" + rand + "-th.png";
    img2.src = "img/dice-" + rand2 + "-th.png";
}*/
</script>
</html>