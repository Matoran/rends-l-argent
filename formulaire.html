<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rends l'argent</title>
    <style>
        canvas {
            height: 700px;
            width: 700px;
            float: left;
        }

        form {
            float: left;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
            integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
            crossorigin="anonymous"></script>
</head>
<body>
<canvas id="canvas" width="700" height="700"></canvas>
<!-- Modal configuration -->
<div class="modal fade" id="configuration" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configuration</h5>
                </div>
                <div class="modal-body">
                    <div class="form-group" id="blocType">
                        <label for="typeCarte">Quel type de carte?</label><br/>
                        <select name="typeCarte" id="typeCarte" class="form-control">
                            <option value="Propriete">Propriété</option>
                            <option value="Gare">Gare</option>
                            <option value="Chance">Chance</option>
                            <option value="Caisse de communaute">Caisse de communauté</option>
                            <option value="Services publiques">Services publiques</option>
                            <option value="Impots et taxe">Impôts et taxe</option>
                        </select>
                    </div>
                    <div class="form-group" id="blocService">
                        <label for="service">Quel type de Service publique?</label>
                        <select name="service" id="service" class="form-control">
                            <option value="Electricite">Electricité</option>
                            <option value="Eau">Eau</option>
                        </select>
                    </div>
                    <div class="form-group" id="blocTaxe">
                        <label for="taxe">Quel type d'impôts et taxe?</label>
                        <select name="taxe" id="taxe" class="form-control">
                            <option value="luxe">Objet de luxe</option>
                            <option value="impots">Impôts</option>
                        </select>
                    </div>
                    <div class="form-group" id="blocName">
                        <label for="name">Nom de la carte</label>
                        <input id="name" name="name" value="Nom" class="form-control">
                    </div>
                    <div class="form-group" id="blocColor">
                        <label for="color">Couleur de la famille de carte</label>
                        <select name="color" id="color" class="form-control">
                            <option value="red">Rouge</option>
                            <option value="blue">Bleu</option>
                            <option value="orange">Orange</option>
                            <option value="black">Noir</option>
                            <option value="green">Vert</option>
                            <option value="purple">Violet</option>
                            <option value="pink">Rose</option>
                            <option value="yellow">Jaune</option>
                        </select>
                    </div>
                    <div class="form-group" id="blocPrice">
                        <label for="name">Prix</label>
                        <input type="number" id="price" name="price" value="1" class="form-control"/>
                    </div>
                    <input type="hidden" id="id" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="send()" data-dismiss="modal">Buy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal auction -->
<div class="modal fade" id="auction" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Auction</h5>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="buyer">Buyer</label>
                        <select class="form-control" id="buyer">
                            <option value="0">Player 1</option>
                            <option value="1">Player 2</option>
                            <option value="2">Player 3</option>
                            <option value="3">Player 4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="priceAuction">Price</label>
                        <input type="number" id="priceAuction" class="form-control"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="finishAuction()" data-dismiss="modal">Buy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="easeljs-0.8.2.min.js"></script>
<script src="Bank.js"></script>
<script src="Cell.js"></script>
<script src="Square.js"></script>
<script src="Tax.js"></script>
<script src="CommunityChest.js"></script>
<script src="Chance.js"></script>
<script src="Buyable.js"></script>
<script src="Station.js"></script>
<script src="Property.js"></script>
<script src="Player.js"></script>
<script src="Card.js"></script>
<script src="Board.js"></script>
<script>
    //----------------draw board-----------------------
    let board = Board();
    let stage = new createjs.Stage("canvas");

    function squareOnClick(identifiant) {
        cleanForm();
        let type = document.getElementById("blocType");
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let id = document.getElementById("id");
        id.value = identifiant;
        type.style.display = "block";
        name.style.display = "block";
        price.style.display = "block";
        color.style.display = "block";
        let card = document.getElementById('typeCarte');
        card.selectedIndex = "Propriete";
        $('#configuration').modal();
    }

    function strcutSquare(posx, posy, w, h, color, id, dx, dy, cell) {
        return {
            posx: posx,
            posy: posy,
            width: w,
            heigth: h,
            color: color,
            id: id,
            directionX: dx,
            directionY: dy,
            cell: cell
        };
    }

    function square(squareParam) {
        let square = new createjs.Shape();
        let commandSquare = square.graphics.beginFill("black").command;
        square.graphics.drawRect(0, 0, squareParam.width, squareParam.heigth);
        square.x = squareParam.posx;
        square.y = squareParam.posy;
        commandSquare.style = squareParam.color;
        if (squareParam.id !== 0 && squareParam.id !== 10 && squareParam.id !== 20 && squareParam.id !== 30) {
            square.on("click", function () {
                squareOnClick(squareParam.id);
            });
        }
        let label = new createjs.Text("", "12px Arial", "#000000");
        stage.addChild(square);
        return {
            square: square,
            commandeSquare: commandSquare,
            label: label,
            struct: squareParam,
            in: undefined,
            circle: undefined,
            img: undefined
        };
    }

    function circle(posx, posy, r, color) {
        let circle = new createjs.Shape();
        let commandeCircle = circle.graphics.beginFill(color).command;
        circle.graphics.drawCircle(0, 0, r);
        circle.x = posx;
        circle.y = posy;
        stage.addChild(circle);
        return {
            circle: circle,
            commandCircle: commandeCircle
        };
    }

    function image(src, posx, posy) {
        let img = new Image();
        img.src = src;
        img.onload = function (event) {
            let image = event.target;
            let bitmap = new createjs.Bitmap(image);
            bitmap.x = posx;
            bitmap.y = posy;
            stage.addChild(bitmap);
            stage.update();
        };
        return img;
    }

    function text(txt, posx, posy, id) {
        tabSquare[id].label.text = txt;
        tabSquare[id].label.x = posx;
        tabSquare[id].label.y = posy;
        tabSquare[id].label.alpha = 0.5;
        stage.addChild(tabSquare[id].label);
        stage.update();
    }

    //draw background
    let background = new createjs.Shape();
    background.graphics.beginFill("#79BD9A").drawRect(0, 0, 700, 700);
    stage.addChild(background);


    //draw board
    let tabSquare = [];
    let color;
    const squareSize = 90;
    const rectangleWidth = 58;
    let y = 0;
    let x = 0;
    let directionX = 1;
    let directionY = 0;
    for (let i = 0; i < 40; i++) {
        let cell = board.squares()[i];
        if (i % 2 === 0) {
            color = "#3B8686";
        } else {
            color = "#0B486B";
        }

        if (i % 10 === 0) {
            if (directionX === -1) {
                x -= squareSize - rectangleWidth;
            }
            tabSquare.push(square(strcutSquare(x, y, squareSize, squareSize, color, i, directionX, directionY, cell)));
            color = "black";
            text(cell.name(), x, y + 20, i);
            if (directionX === 1 && i !== 0) {
                directionX = 0;
                directionY = 1;
                y += squareSize;
            } else if (directionY === 1) {
                directionX = -1;
                directionY = 0;
                x -= rectangleWidth;
            } else if (directionX === -1) {
                directionX = 0;
                directionY = -1;
                y -= rectangleWidth;
            } else if (directionX === 1) {
                x += squareSize;
            }
        } else {
            if (directionX === 1 || directionX === -1) {
                tabSquare.push(square(strcutSquare(x, y, rectangleWidth, squareSize, color, i, directionX, directionY, cell)));
                if (cell.isBuyable()) {
                    if (directionX === 1) {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + rectangleWidth / 2, y + squareSize + 10, 5, color);
                    } else {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + rectangleWidth / 2, y - 10, 5, color);
                    }
                }
                if (cell.isProperty()) {
                    if (directionX === 1) {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + squareSize - 20, rectangleWidth - 20, 10, color, i, directionX, directionY, cell));
                    } else {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + 10, rectangleWidth - 20, 10, color, i, directionX, directionY, cell));
                    }
                } else if (cell.isTrain()) {
                    tabSquare[i].img = image("img/train.png", x, y);
                } else if (cell.isChance()) {
                    tabSquare[i].img = image("img/chance.png", x, y);
                } else if (cell.isCommunityChest()) {
                    tabSquare[i].img = image("img/chest.png", x, y);
                } else if (cell.isTax()) {
                    tabSquare[i].img = image("img/tax.png", x, y);
                }

                x += rectangleWidth * directionX;
                y += squareSize * directionY;

            } else if (directionY === 1 || directionY === -1) {
                tabSquare.push(square(strcutSquare(x, y, squareSize, rectangleWidth, color, i, directionX, directionY, cell)));
                if (cell.isBuyable()) {
                    if (directionY === 1) {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x - 10, y + rectangleWidth / 2, 5, color);
                    } else {
                        color = cell.owner.color();
                        tabSquare[i].circle = circle(x + squareSize + 10, y + rectangleWidth / 2, 5, color);
                    }
                }
                if (cell.isProperty()) {
                    if (directionY === 1) {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + 10, y + 10, 10, rectangleWidth - 20, color, i, directionX, directionY, cell));
                    } else {
                        color = cell.color();
                        tabSquare[i].in = square(strcutSquare(x + squareSize - 20, y + 10, 10, rectangleWidth - 20, color, i, directionX, directionY, cell));
                    }
                } else if (cell.isTrain()) {
                    tabSquare[i].img = image("img/train.png", x, y);
                } else if (cell.isChance()) {
                    tabSquare[i].img = image("img/chance.png", x, y);
                } else if (cell.isCommunityChest()) {
                    tabSquare[i].img = image("img/chest.png", x, y);
                } else if (cell.isTax()) {
                    tabSquare[i].img = image("img/tax.png", x, y);
                }
                x += squareSize * directionX;
                y += rectangleWidth * directionY;
            }
        }
    }

    tabSquare.forEach(function (s) {
        stage.addChild(s.label);
    });
    stage.update();

    //----------Form--------------------
    var card = document.getElementById('typeCarte');
    // change the form
    card.addEventListener('change', function () {
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let service = document.getElementById("blocService");
        let taxe = document.getElementById("blocTaxe");

        let value = card.options[card.selectedIndex].value;

        name.style.display = "none";
        price.style.display = "none";
        color.style.display = "none";
        service.style.display = "none";
        taxe.style.display = "none";

        if (value === "Propriete") {
            name.style.display = "block";
            price.style.display = "block";
            color.style.display = "block";
        } else if (value === "Gare") {
            name.style.display = "block";
            price.style.display = "block";
        } else if (value === "Services publiques") {
            service.style.display = "block";
        } else if (value === "Impots et taxe") {
            taxe.style.display = "block";
            price.style.display = "block";
        }
    });

    function cleanForm() {
        let type = document.getElementById("blocType");
        let name = document.getElementById("blocName");
        let price = document.getElementById("blocPrice");
        let color = document.getElementById("blocColor");
        let id = document.getElementById("id");
        let service = document.getElementById("blocService");
        let taxe = document.getElementById("blocTaxe");
        id.value = 0;
        type.style.display = "none";
        name.style.display = "none";
        price.style.display = "none";
        color.style.display = "none";
        service.style.display = "none";
        taxe.style.display = "none";
    }

    function send() {
        let id = document.getElementById("id").value;
        let value = card.options[card.selectedIndex].value;
        let name = document.getElementById("name").value;
        let color = document.getElementById("color").value;
        let price = document.getElementById("price").value;
        let service = document.getElementById("service");
        service = service.options[service.selectedIndex].value;
        let taxe = document.getElementById("taxe");
        taxe = taxe.options[taxe.selectedIndex].value;

        if (tabSquare[id].in !== undefined) {
            stage.removeChild(tabSquare[id].in.square);
        }

        if (tabSquare[id].circle !== undefined) {
            stage.removeChild(tabSquare[id].circle.circle);
            tabSquare[id].circle = undefined;
        }

        if (tabSquare[id].img !== undefined) {
            stage.removeChild(tabSquare[id].img.src = "");
        }


        let x = tabSquare[id].struct.posx;
        let y = tabSquare[id].struct.posy;
        let dx = tabSquare[id].struct.directionX;
        let dy = tabSquare[id].struct.directionY;
        let cell = tabSquare[id].struct.cell;
        if (dx === 1 || dx === -1) {
            if (value === "Propriete" || value === "Gare") {
                if (dx === 1) {
                    tabSquare[id].circle = circle(x + rectangleWidth / 2, y + squareSize + 10, 5, "yellow");
                } else {
                    tabSquare[id].circle = circle(x + rectangleWidth / 2, y - 10, 5, "yellow");
                }
            }
            if (value === "Propriete") {
                if (dx === 1) {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + squareSize - 20, rectangleWidth - 20, 10, color, id, dx, dy, cell));
                } else {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + 10, rectangleWidth - 20, 10, color, id, dx, dy, cell));
                }
            }
        } else if (dy === 1 || dy === -1) {
            if (value === "Propriete" || value === "Gare") {
                if (dy === 1) {
                    tabSquare[id].circle = circle(x - 10, y + rectangleWidth / 2, 5, "yellow");
                } else {
                    tabSquare[id].circle = circle(x + squareSize + 10, y + rectangleWidth / 2, 5, "yellow");
                }
            }
            if (value === "Propriete") {
                if (dy === 1) {
                    tabSquare[id].in = square(strcutSquare(x + 10, y + 10, 10, rectangleWidth - 20, color, id, dx, dy, cell));
                } else {
                    tabSquare[id].in = square(strcutSquare(x + squareSize - 20, y + 10, 10, rectangleWidth - 20, color, id, dx, dy, cell));
                }
            }
        }

        if(value === "Gare"){
            tabSquare[id].img = image("img/train.png", x, y);
            board.squares()[id] = Station(name,price);
        }else if(value === "Impots et taxe"){
            tabSquare[id].img = image("img/tax.png", x, y);
            board.squares()[id] = Tax(name,price);
        }else if(value === "Caisse de communaute"){
            tabSquare[id].img = image("img/chest.png", x, y);
            board.squares()[id] = CommunityChest();
        }else if(value === "Chance"){
            tabSquare[id].img = image("img/chance.png", x, y);
            board.squares()[id] = Chance();
        }else if(value === "Propriete"){
            board.squares()[id] = Property(name,price,color);
        }
        /*else if(value === "Services publiques"){

                }*/


        stage.update();
        cleanForm();
    }

    //----------Move Player--------
    let tabTokens = [];
    board.players().forEach(function (p) {
        tabTokens.push(circle(tabSquare[p.position()].square.x + 25, tabSquare[p.position()].square.y + 25, 7, p.color()));
    });

    function movePlayers() {
        for (let i = 0; i < tabTokens.length; i++) {
            tabTokens[i].circle.x = tabSquare[board.players()[i].position()].square.x + 25 + (i * 8);
            tabTokens[i].circle.y = tabSquare[board.players()[i].position()].square.y + 25 + (i * 8);
        }
        stage.update();
    }

    //-------------Play--------------
    movePlayers();
    let squares = [];
    let labels = [];
    let namePlayer = new createjs.Text("", "16px Arial", "#000000");
    namePlayer.x = 250;
    namePlayer.y = 120;
    let img = new Image();
    let img2 = new Image();
    function drawImage(posx,posy, event) {
        let image = event.target;
        let bitmap = new createjs.Bitmap(image);
        bitmap.x = posx;
        bitmap.y = posy;
        stage.addChild(bitmap);
        stage.update();
    }

    img.onload = function (event) {drawImage(200,330, event);};
    img2.onload = function (event) {drawImage(300,330, event);};
    let test;
    play();

    function play() {
        let tabAction = board.actions();
        if (test) {
            namePlayer.text = board.players()[board.activePlayer()].color() + " turn";
            namePlayer.text += "\n\nYou have: " + board.players()[board.activePlayer()].money() + " monopoly";
            if (tabAction[0].name === "buy") {
                namePlayer.text += "\n\nThe price is: " + board.squares()[board.players()[board.activePlayer()].position()].price() + " monopoly";
            }
            namePlayer.color = board.players()[board.activePlayer()].color();
        }
        test = true;
        squares.forEach(function (s) {
            stage.removeChild(s);
        });
        labels.forEach(function (l) {
            stage.removeChild(l);
        });
        squares = [];
        for (let i = 0; i < tabAction.length; i++) {
            let square = new createjs.Shape();
            square.graphics.beginFill("#0B486B").drawRect(0, 0, 80, 80);
            square.x = 210 + (i * 85);
            square.y = 440;
            square.on("click", function () {
                if (tabAction[i].name === "surrender") {
                    stage.removeChild(tabTokens[board.activePlayer()].circle);
                    tabTokens.splice(board.activePlayer(), 1);
                }
                let ret = tabAction[i]();
                if (ret !== undefined) {
                    if (ret.hasOwnProperty("dice1")) {
                        img.src = "img/dice-" + ret.dice1 + "-th.png";
                        img2.src = "img/dice-" + ret.dice2 + "-th.png";
                    } else {
                        img.src = "";
                        img2.src = "";
                    }
                    if (ret.text !== "") {
                        namePlayer.text = board.players()[board.activePlayer()].color() + " turn";
                        namePlayer.text += "\n\nYou have: " + board.players()[board.activePlayer()].money() + " monopoly";
                        namePlayer.text += "\n\n" + ret.text;
                        test = false;
                    }
                }

                if (tabAction[i].name === "buy") {
                    tabSquare[board.players()[board.activePlayer()].position()].circle.commandCircle.style = board.players()[board.activePlayer()].color();
                }
                if (tabAction[i].name === "auction") {
                    $('#auction').modal();
                }

                if (tabAction[i].name === "trade") {
                    $('#trade').modal();
                }



                movePlayers();
                play();
            });
            stage.addChild(namePlayer);
            stage.update();
            let label = new createjs.Text("", "15px Arial", "#000000");
            label.text = tabAction[i].name;
            label.x = square.x+20;
            label.y = square.y+25;
            squares.push(square);
            labels.push(label);
            stage.addChild(square);
            stage.addChild(label);
            stage.update();
        }
    }

    function finishAuction() {
        let buyer = $('#buyer').val();
        board.finishAuction(buyer, $('#priceAuction').val());
        tabSquare[board.players()[board.activePlayer()].position()].circle.commandCircle.style = board.players()[buyer].color();
        stage.update();
    }
</script>
</html>